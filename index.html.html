
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>خريطة نجران – ألوان + صورة جانبية (إضافة/حذف برمز 1177)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .leaflet-control-custom {
      background: white;
      padding: 5px;
      cursor: pointer;
      font-size: 12px;
      margin-bottom: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      user-select: none;
    }
    .legend {
      background: white;
      padding: 6px 8px;
      font: 14px Arial, sans-serif;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: right;
      margin-left: 8px;
      opacity: 0.9;
    }
    .img-preview {
      max-width: 180px;
      max-height: 120px;
      display: block;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .field-label{font: 13px Arial; display:block; margin-top:6px;}
    input[type='text']{width: 95%; padding:4px; font: 13px Arial;}
    .small-btn{margin-top:6px; padding:4px 8px; font: 12px Arial;}
    .status{
      position: fixed; top: 10px; right: 10px; z-index: 999;
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      padding: 6px 10px; font: 13px Tahoma, Arial;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="status">الوضع: <b id="modeLbl">عرض</b> — الصلاحية: <b id="roleLbl">زائر</b></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// ========== إعداد كلمة السر لإضافة/حذف ==========
const ADMIN_PIN = "1177";
let isAdmin = false;

function requireAdmin(){
  if(isAdmin) return true;
  const code = prompt("أدخل كلمة السر لإضافة/حذف النقاط:");
  if(code === ADMIN_PIN){
    isAdmin = true;
    document.getElementById('roleLbl').textContent = "مصرّح";
    alert("تم التحقق. يمكنك الآن الإضافة/الحذف.");
    return true;
  } else {
    alert("رمز غير صحيح.");
    return false;
  }
}

function createIcon(color) {
  return new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + color + '.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}

// نقاط افتراضية
var points = [
  {lat: 17.565, lon: 44.228, title: "حي الملك سعود", desc: "منطقة نظيفة", status: "green"},
  {lat: 17.540, lon: 44.220, title: "حي الفيصلية", desc: "تحتاج نظافة", status: "red"},
  {lat: 17.520, lon: 44.250, title: "حي الجربة", desc: "نظافة جيدة", status: "green"},
  {lat: 17.500, lon: 44.240, title: "حي الغابة", desc: "نفايات موجودة", status: "red"}
];

// استرجاع من المتصفح
if(localStorage.getItem("najranPointsColorImg_PIN")){
  try { points = JSON.parse(localStorage.getItem("najranPointsColorImg_PIN")); } catch(e){}
}

var map = L.map('map').setView([17.54, 44.22], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

var addMode = false, deleteMode = false;
const modeLbl = document.getElementById('modeLbl');

function setMode(m){
  addMode = (m === 'add');
  deleteMode = (m === 'delete');
  modeLbl.textContent = addMode ? "إضافة نقطة" : deleteMode ? "حذف نقطة" : "عرض";
}

var markers = [];
function renderPoints(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  points.forEach((p, index) => {
    var color = p.status || "blue";
    var marker = L.marker([p.lat, p.lon], {icon: createIcon(color)}).addTo(map);

    var imgHtml = p.img ? ("<img class='img-preview' src='" + p.img + "' alt='صورة النقطة'/>") : "<span style='color:#777; font:12px Arial;'>لا توجد صورة</span>";
    var popupContent = ""
      + "<b>" + p.title + "</b><br>" + (p.desc||"") + "<br>"
      + "الحالة: <select id='colorSelect_" + index + "'>"
      +   "<option value='green' " + (p.status==='green'?'selected':'') + ">نظيف</option>"
      +   "<option value='yellow' " + (p.status==='yellow'?'selected':'') + ">متوسط</option>"
      +   "<option value='red' " + (p.status==='red'?'selected':'') + ">سيء</option>"
      + "</select> "
      + "<button class='small-btn' onclick='updateColor(" + index + ")'>تحديث اللون</button>"
      + imgHtml;

    marker.bindPopup(popupContent);

    marker.on('click', function(){
      if(deleteMode){
        if(!isAdmin && !requireAdmin()) return;
        if(confirm("تأكيد حذف هذه النقطة؟")){
          points.splice(index, 1);
          saveToLocal();
          renderPoints();
        }
      }
    });

    markers.push(marker);
  });
}

function updateColor(index){
  var select = document.getElementById("colorSelect_" + index);
  if(select){
    points[index].status = select.value;
    saveToLocal();
    renderPoints();
  }
}

function saveToLocal(){
  localStorage.setItem("najranPointsColorImg_PIN", JSON.stringify(points));
}

function addButton(label, onClick){
  var customControl = L.Control.extend({
    options: { position: 'topright' },
    onAdd: function () {
      var btn = L.DomUtil.create('div', 'leaflet-control-custom');
      btn.innerHTML = label;
      L.DomEvent.on(btn, 'click', onClick);
      return btn;
    }
  });
  map.addControl(new customControl());
}

addButton("🔑 تفعيل الإضافة/الحذف", function(){
  requireAdmin();
});

addButton("➕ إضافة نقطة", function(){
  if(!isAdmin && !requireAdmin()) return;
  setMode('add');
});
addButton("❌ حذف نقطة", function(){
  if(!isAdmin && !requireAdmin()) return;
  setMode('delete');
});
addButton("👁 عرض فقط", function(){ setMode('view'); });

addButton("💾 حفظ", function(){ saveToLocal(); alert('تم الحفظ في المتصفح'); });

addButton("📥 تنزيل JSON", function(){
  var blob = new Blob([JSON.stringify(points)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = "najran_points_with_images_PIN.json";
  a.click();
  URL.revokeObjectURL(url);
});

addButton("🔄 استرجاع الافتراضي", function(){
  if(!isAdmin && !requireAdmin()) return;
  if(confirm("هل تريد استرجاع البيانات الافتراضية؟ سيؤدي ذلك لمسح الحفظ المحلي!")){
    localStorage.removeItem("najranPointsColorImg_PIN");
    points = [
      {lat: 17.565, lon: 44.228, title: "حي الملك سعود", desc: "منطقة نظيفة", status: "green"},
      {lat: 17.540, lon: 44.220, title: "حي الفيصلية", desc: "تحتاج نظافة", status: "red"},
      {lat: 17.520, lon: 44.250, title: "حي الجربة", desc: "نظافة جيدة", status: "green"},
      {lat: 17.500, lon: 44.240, title: "حي الغابة", desc: "نفايات موجودة", status: "red"}
    ];
    renderPoints();
  }
});

// إضافة نقطة جديدة بالنقر على الخريطة (يتطلب صلاحية)
map.on('click', function(e){
  if(addMode){
    if(!isAdmin && !requireAdmin()) return;
    var title = prompt("أدخل اسم النقطة:");
    if(!title) return;
    var desc = prompt("أدخل الوصف:");
    var statusChoice = prompt("أدخل الحالة: green للنظيف، yellow للمتوسط، red لسيء:");
    if(!statusChoice) statusChoice = "green";
    points.push({lat: e.latlng.lat, lon: e.latlng.lng, title: title, desc: desc, status: statusChoice});
    saveToLocal();
    renderPoints();
  }
});

// Legend
var legend = L.control({position: 'bottomleft'});
legend.onAdd = function (map) {
  var div = L.DomUtil.create('div', 'legend');
  div.innerHTML += '<i style="background: url(https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png) no-repeat center; background-size: contain;"></i> نظيف<br>';
  div.innerHTML += '<i style="background: url(https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png) no-repeat center; background-size: contain;"></i> متوسط<br>';
  div.innerHTML += '<i style="background: url(https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png) no-repeat center; background-size: contain;"></i> سيء<br>';
  return div;
};
legend.addTo(map);

renderPoints();
</script>
</body>
</html>
