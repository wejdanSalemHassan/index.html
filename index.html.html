
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø®Ø±ÙŠØ·Ø© Ù†Ø¬Ø±Ø§Ù† â€“ Ø£Ù„ÙˆØ§Ù† + ØµÙˆØ±Ø© Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù Ø¨Ø±Ù…Ø² 1177)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .leaflet-control-custom {
      background: white;
      padding: 5px;
      cursor: pointer;
      font-size: 12px;
      margin-bottom: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      user-select: none;
    }
    .legend {
      background: white;
      padding: 6px 8px;
      font: 14px Arial, sans-serif;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: right;
      margin-left: 8px;
      opacity: 0.9;
    }
    .img-preview {
      max-width: 180px;
      max-height: 120px;
      display: block;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .field-label{font: 13px Arial; display:block; margin-top:6px;}
    input[type='text']{width: 95%; padding:4px; font: 13px Arial;}
    .small-btn{margin-top:6px; padding:4px 8px; font: 12px Arial;}
    .status{
      position: fixed; top: 10px; right: 10px; z-index: 999;
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      padding: 6px 10px; font: 13px Tahoma, Arial;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="status">Ø§Ù„ÙˆØ¶Ø¹: <b id="modeLbl">Ø¹Ø±Ø¶</b> â€” Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: <b id="roleLbl">Ø²Ø§Ø¦Ø±</b></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// ========== Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù ==========
const ADMIN_PIN = "1177";
let isAdmin = false;

function requireAdmin(){
  if(isAdmin) return true;
  const code = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù Ø§Ù„Ù†Ù‚Ø§Ø·:");
  if(code === ADMIN_PIN){
    isAdmin = true;
    document.getElementById('roleLbl').textContent = "Ù…ØµØ±Ù‘Ø­";
    alert("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„Ø­Ø°Ù.");
    return true;
  } else {
    alert("Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­.");
    return false;
  }
}

function createIcon(color) {
  return new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + color + '.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}

// Ù†Ù‚Ø§Ø· Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
var points = [
  {lat: 17.565, lon: 44.228, title: "Ø­ÙŠ Ø§Ù„Ù…Ù„Ùƒ Ø³Ø¹ÙˆØ¯", desc: "Ù…Ù†Ø·Ù‚Ø© Ù†Ø¸ÙŠÙØ©", status: "green"},
  {lat: 17.540, lon: 44.220, title: "Ø­ÙŠ Ø§Ù„ÙÙŠØµÙ„ÙŠØ©", desc: "ØªØ­ØªØ§Ø¬ Ù†Ø¸Ø§ÙØ©", status: "red"},
  {lat: 17.520, lon: 44.250, title: "Ø­ÙŠ Ø§Ù„Ø¬Ø±Ø¨Ø©", desc: "Ù†Ø¸Ø§ÙØ© Ø¬ÙŠØ¯Ø©", status: "green"},
  {lat: 17.500, lon: 44.240, title: "Ø­ÙŠ Ø§Ù„ØºØ§Ø¨Ø©", desc: "Ù†ÙØ§ÙŠØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©", status: "red"}
];

// Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
if(localStorage.getItem("najranPointsColorImg_PIN")){
  try { points = JSON.parse(localStorage.getItem("najranPointsColorImg_PIN")); } catch(e){}
}

var map = L.map('map').setView([17.54, 44.22], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

var addMode = false, deleteMode = false;
const modeLbl = document.getElementById('modeLbl');

function setMode(m){
  addMode = (m === 'add');
  deleteMode = (m === 'delete');
  modeLbl.textContent = addMode ? "Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©" : deleteMode ? "Ø­Ø°Ù Ù†Ù‚Ø·Ø©" : "Ø¹Ø±Ø¶";
}

var markers = [];
function renderPoints(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  points.forEach((p, index) => {
    var color = p.status || "blue";
    var marker = L.marker([p.lat, p.lon], {icon: createIcon(color)}).addTo(map);

    var imgHtml = p.img ? ("<img class='img-preview' src='" + p.img + "' alt='ØµÙˆØ±Ø© Ø§Ù„Ù†Ù‚Ø·Ø©'/>") : "<span style='color:#777; font:12px Arial;'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</span>";
    var popupContent = ""
      + "<b>" + p.title + "</b><br>" + (p.desc||"") + "<br>"
      + "Ø§Ù„Ø­Ø§Ù„Ø©: <select id='colorSelect_" + index + "'>"
      +   "<option value='green' " + (p.status==='green'?'selected':'') + ">Ù†Ø¸ÙŠÙ</option>"
      +   "<option value='yellow' " + (p.status==='yellow'?'selected':'') + ">Ù…ØªÙˆØ³Ø·</option>"
      +   "<option value='red' " + (p.status==='red'?'selected':'') + ">Ø³ÙŠØ¡</option>"
      + "</select> "
      + "<button class='small-btn' onclick='updateColor(" + index + ")'>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ†</button>"
      + imgHtml;

    marker.bindPopup(popupContent);

    marker.on('click', function(){
      if(deleteMode){
        if(!isAdmin && !requireAdmin()) return;
        if(confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø©ØŸ")){
          points.splice(index, 1);
          saveToLocal();
          renderPoints();
        }
      }
    });

    markers.push(marker);
  });
}

function updateColor(index){
  var select = document.getElementById("colorSelect_" + index);
  if(select){
    points[index].status = select.value;
    saveToLocal();
    renderPoints();
  }
}

function saveToLocal(){
  localStorage.setItem("najranPointsColorImg_PIN", JSON.stringify(points));
}

function addButton(label, onClick){
  var customControl = L.Control.extend({
    options: { position: 'topright' },
    onAdd: function () {
      var btn = L.DomUtil.create('div', 'leaflet-control-custom');
      btn.innerHTML = label;
      L.DomEvent.on(btn, 'click', onClick);
      return btn;
    }
  });
  map.addControl(new customControl());
}

addButton("ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„Ø­Ø°Ù", function(){
  requireAdmin();
});

addButton("â• Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø©", function(){
  if(!isAdmin && !requireAdmin()) return;
  setMode('add');
});
addButton("âŒ Ø­Ø°Ù Ù†Ù‚Ø·Ø©", function(){
  if(!isAdmin && !requireAdmin()) return;
  setMode('delete');
});
addButton("ğŸ‘ Ø¹Ø±Ø¶ ÙÙ‚Ø·", function(){ setMode('view'); });

addButton("ğŸ’¾ Ø­ÙØ¸", function(){ saveToLocal(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­'); });

addButton("ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ JSON", function(){
  var blob = new Blob([JSON.stringify(points)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = "najran_points_with_images_PIN.json";
  a.click();
  URL.revokeObjectURL(url);
});

addButton("ğŸ”„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ", function(){
  if(!isAdmin && !requireAdmin()) return;
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ø°Ù„Ùƒ Ù„Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ!")){
    localStorage.removeItem("najranPointsColorImg_PIN");
    points = [
      {lat: 17.565, lon: 44.228, title: "Ø­ÙŠ Ø§Ù„Ù…Ù„Ùƒ Ø³Ø¹ÙˆØ¯", desc: "Ù…Ù†Ø·Ù‚Ø© Ù†Ø¸ÙŠÙØ©", status: "green"},
      {lat: 17.540, lon: 44.220, title: "Ø­ÙŠ Ø§Ù„ÙÙŠØµÙ„ÙŠØ©", desc: "ØªØ­ØªØ§Ø¬ Ù†Ø¸Ø§ÙØ©", status: "red"},
      {lat: 17.520, lon: 44.250, title: "Ø­ÙŠ Ø§Ù„Ø¬Ø±Ø¨Ø©", desc: "Ù†Ø¸Ø§ÙØ© Ø¬ÙŠØ¯Ø©", status: "green"},
      {lat: 17.500, lon: 44.240, title: "Ø­ÙŠ Ø§Ù„ØºØ§Ø¨Ø©", desc: "Ù†ÙØ§ÙŠØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©", status: "red"}
    ];
    renderPoints();
  }
});

// Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ©)
map.on('click', function(e){
  if(addMode){
    if(!isAdmin && !requireAdmin()) return;
    var title = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ù‚Ø·Ø©:");
    if(!title) return;
    var desc = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØµÙ:");
    var statusChoice = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø­Ø§Ù„Ø©: green Ù„Ù„Ù†Ø¸ÙŠÙØŒ yellow Ù„Ù„Ù…ØªÙˆØ³Ø·ØŒ red Ù„Ø³ÙŠØ¡:");
    if(!statusChoice) statusChoice = "green";
    points.push({lat: e.latlng.lat, lon: e.latlng.lng, title: title, desc: desc, status: statusChoice});
    saveToLocal();
    renderPoints();
  }
});

// Legend
var legend = L.control({position: 'bottomleft'});
legend.onAdd = function (map) {
  var div = L.DomUtil.create('div', 'legend');
  div.innerHTML += '<i style="background: url(https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png) no-repeat center; background-size: contain;"></i> Ù†Ø¸ÙŠÙ<br>';
  div.innerHTML += '<i style="background: url(https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png) no-repeat center; background-size: contain;"></i> Ù…ØªÙˆØ³Ø·<br>';
  div.innerHTML += '<i style="background: url(https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png) no-repeat center; background-size: contain;"></i> Ø³ÙŠØ¡<br>';
  return div;
};
legend.addTo(map);

renderPoints();
</script>
</body>
</html>
